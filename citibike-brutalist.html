<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Citi Bike — 24h Flow (Calm Base + Labels Overlay, Fixed Snapshot)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  :root{ --ink:#000; --paper:#fff; --muted:#f6f6f6; }
  html,body{height:100%;margin:0;background:var(--muted);
    font-family:ui-monospace,Menlo,Consolas,monospace}
  #map{height:100vh}
  .controls{
    position:fixed;left:0;right:0;bottom:0;z-index:1000;
    display:flex;gap:12px;align-items:center;
    background:var(--paper); border-top:2px solid var(--ink);
    padding:8px 12px; text-transform:uppercase; font-size:12px; letter-spacing:.02em;
  }
  .chip{border:2px solid var(--ink); padding:3px 8px; background:var(--paper)}
  .spacer{flex:1}
  input[type=range]{appearance:none;height:20px;background:transparent;cursor:pointer}
  input[type=range]::-webkit-slider-runnable-track{height:4px;background:var(--ink)}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:16px;width:10px;background:var(--paper);border:2px solid var(--ink);margin-top:-6px}
  input[type=range]::-moz-range-track{height:4px;background:var(--ink)}
  input[type=range]::-moz-range-thumb{height:16px;width:10px;background:var(--paper);border:2px solid var(--ink)}
  .legend{display:flex;gap:8px;align-items:center}
  .sw{width:12px;height:12px;border:2px solid var(--ink)}
  .sw.orange{background:#ff7f11}
  .sw.blue{background:#1f78ff}
</style>
</head>
<body>
<div id="map"></div>
<div class="controls">
  <div class="legend">
    <span class="sw orange"></span><span>Drop-offs ↑</span>
    <span class="sw blue"></span><span>Pickups ↓</span>
  </div>
  <label style="display:flex;gap:8px;align-items:center">
    <span>Sensitivity</span>
    <input id="thresh" type="range" min="0" max="20" step="1" value="1">
    <span id="threshVal" class="chip">1</span>
  </label>
  <span class="spacer"></span>
  <span class="chip">Rolling 24h</span>
  <span id="lastUpdate" class="chip">…</span>
</div>

<script>
/* ----------------------------- Config ------------------------------ */
const INFO_URL     = "https://gbfs.citibikenyc.com/gbfs/en/station_information.json";
const STATUS_URL   = "https://gbfs.citibikenyc.com/gbfs/en/station_status.json";
const SNAPSHOT_URL = "https://vertefeuilles.github.io/bike-tracker/snapshot.json";

const POLL_MS   = 60_000;
const WINDOW_MS = 24*60*60*1000;
const PRUNE_MS  = 36*60*60*1000;

const APEX_POS  = [255,127,17];   // orange (drop-offs)
const APEX_NEG  = [31,120,255];   // blue (pickups)
const NEUTRAL   = [122,110,98];
const STROKE    = "#111";
const FILL_OP   = 0.88;
const STROKE_W  = 1.25;

const R_MIN     = 3;
const R_MAX     = 12;
const SIZE_EXP  = 0.5;

let threshold = 1;
const infoById = {}, lastSeen = {}, deltas = {}, markerById = {};

const map = L.map("map").setView([40.73, -73.99], 13);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
  { maxZoom: 19, attribution: "© OpenStreetMap, © CARTO" }).addTo(map);
map.createPane("labels");
map.getPane("labels").style.zIndex = 650;
map.getPane("labels").style.pointerEvents = "none";
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png",
  { pane:"labels", maxZoom:19 }).addTo(map);

const renderer = L.canvas({ padding: 0.5 });

/* ----------------------------- Helpers ------------------------------ */
function sum24h(arr, endMs){
  if(!arr) return 0;
  const from = endMs - WINDOW_MS;
  return arr.filter(e=>e.t>=from && e.t<=endMs).reduce((s,e)=>s+e.delta,0);
}
function p90(values){
  if(!values.length) return 1;
  const a=[...values].sort((x,y)=>x-y);
  return Math.max(1,a[Math.floor(0.9*(a.length-1))]);
}
function scaleRadius(mag, scale){
  const w = Math.pow(Math.min(1, mag/scale), SIZE_EXP);
  return R_MIN + (R_MAX-R_MIN)*w;
}
function lerp(a,b,t){ return a+(b-a)*t; }
function lerpColor(c0,c1,t){
  return `rgb(${Math.round(lerp(c0[0],c1[0],t))},${Math.round(lerp(c0[1],c1[1],t))},${Math.round(lerp(c0[2],c1[2],t))})`;
}
function pruneHistory(now){
  const cutoff=now-PRUNE_MS;
  for(const id in deltas){ deltas[id]=deltas[id].filter(e=>e.t>=cutoff); }
}

/* ----------------------------- Data ---------------------------- */
async function loadInfo(){
  const r=await fetch(INFO_URL); const stations=(await r.json()).data.stations;
  stations.forEach(s=>infoById[s.station_id]=s);
}
async function trySeedFromSnapshot(){
  try{
    const r=await fetch(SNAPSHOT_URL,{cache:"no-store"});
    if(!r.ok) return;
    const snap=await r.json(); const t=new Date(snap.generated_at).getTime();
    for(const s of snap.stations){
      const id=s.id, raw=s.net;
      if(raw===0) continue;
      if(!deltas[id]) deltas[id]=[];
      deltas[id].push({t, delta: -raw}); // <<< flipped sign here
    }
    document.getElementById("lastUpdate").textContent="Precomputed "+new Date(t).toLocaleTimeString();
    render();
  }catch(_){}
}
async function pollStatus(){
  const r=await fetch(STATUS_URL,{cache:"no-store"});
  if(!r.ok) return;
  const now=Date.now();
  const stations=(await r.json()).data.stations;
  let any=false;
  for(const s of stations){
    const id=s.station_id, bikes=s.num_bikes_available;
    if(lastSeen[id]==null){ lastSeen[id]=bikes; continue; }
    const d=bikes-lastSeen[id]; lastSeen[id]=bikes;
    if(d!==0 && s.is_installed && s.is_renting && s.is_returning){
      (deltas[id]??=[]).push({t:now,delta:d}); any=true;
    }
  }
  pruneHistory(now); if(any) render();
  document.getElementById("lastUpdate").textContent="Updated "+new Date(now).toLocaleTimeString();
}

/* ------------------------------- UI -------------------------------- */
document.getElementById("thresh").addEventListener("input",e=>{
  threshold=+e.target.value;
  document.getElementById("threshVal").textContent=threshold;
  render();
});

/* ------------------------------ Render ------------------------------ */
function render(){
  const end=Date.now(), mags=[];
  for(const id in infoById){
    const net=sum24h(deltas[id],end); if(Math.abs(net)>=threshold) mags.push(Math.abs(net));
  }
  const scale=p90(mags), seen=new Set();
  for(const id in infoById){
    const st=infoById[id], net=sum24h(deltas[id],end), mag=Math.abs(net);
    if(mag<threshold||net===0){ if(markerById[id]) map.removeLayer(markerById[id]); continue; }
    const r=scaleRadius(mag,scale);
    const apex=net>0?APEX_POS:APEX_NEG;
    const fill=lerpColor(NEUTRAL,apex,Math.pow(Math.min(1,mag/scale),SIZE_EXP));
    let m=markerById[id];
    if(!m){
      m=L.circleMarker([st.lat,st.lon],{renderer,radius:r,color:STROKE,weight:STROKE_W,fillColor:fill,fillOpacity:FILL_OP}).addTo(map);
      markerById[id]=m;
    }else{ m.setLatLng([st.lat,st.lon]); m.setRadius(r); m.setStyle({fillColor:fill}); }
    m.bindTooltip(`${st.name}<br>Net 24h: <b>${net>0?"+":""}${net}</b>`,{sticky:true});
    seen.add(id);
  }
  for(const id in markerById) if(!seen.has(id)) map.removeLayer(markerById[id]);
}

/* ------------------------------ Init ------------------------------- */
(async function init(){
  await loadInfo(); await trySeedFromSnapshot(); await pollStatus();
  setInterval(pollStatus,POLL_MS);
})();
</script>
</body>
</html>
